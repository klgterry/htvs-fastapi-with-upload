{% extends "base.html" %}

{% block title %}HTVS Dashboard{% endblock %}

{% block content %}
<div style="padding-left: 40px; padding-top: 30px;">
    <h2 style="margin-top: 30px;">ğŸš€ ì‹¤í–‰ ëŒ€ì‹œë³´ë“œ</h2>
    <p>ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì„ í™•ì¸í•˜ê³ , ì™„ë£Œëœ ê²°ê³¼ë¥¼ ì—´ì–´ë³´ì„¸ìš”.</p>

    <div id="dashboard" style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 24px;">
    {% for run in runs %}
        <div class="run-card"
            id="{{ run.run_id }}"
            style="border: 2px solid #ccc; border-radius: 8px; padding: 16px; width: 300px; background-color: #fdfdfd; box-shadow: 2px 2px 6px rgba(0,0,0,0.05);">
        
        <!-- ìƒíƒœ ì˜ì—­: JavaScriptë¡œ ê°±ì‹ ë¨ -->
        <h3 class="status" style="margin-top: 0;">
            {% if run.status == "DONE" %}
            ğŸŸ¢ ì™„ë£Œ
            {% elif run.status == "RUNNING" %}
            ğŸŸ¡ ì‹¤í–‰ ì¤‘
            {% else %}
            ğŸ”´ ì‹¤íŒ¨
            {% endif %}
        </h3>

        <p><strong>Run ID:</strong> {{ run.run_id }}</p>
        <p><strong style="color:#003366;">User:</strong> {{ run.user }}</p>
        <p><strong style="color:#003366;">Job Name:</strong> {{ run.job_name }}</p>
        <p><strong>ì‹œì‘ ì‹œê°:</strong> {{ run.start_time }}</p>

        <!-- ì§„í–‰ë¥  ì˜ì—­: JavaScriptë¡œ ê°±ì‹ ë¨ -->
        <p class="progress">ì§„í–‰: {{ run.succeeded }}/{{ run.total }}</p>

        <a href="/results/{{ run.run_id }}" style="color: #007acc;">ğŸ“„ ê²°ê³¼ ë³´ê¸°</a>
        <button class="delete-btn" data-run="{{ run.run_id }}">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
    {% endfor %}
    </div>
 </div>


<script>
  // âœ… 1. highlight=run_xxx íŒŒë¼ë¯¸í„° íŒŒì‹± ë° ì¹´ë“œ ê°•ì¡°
  const params = new URLSearchParams(window.location.search);
  const highlightId = params.get("highlight");
  if (highlightId) {
    const el = document.getElementById(highlightId);
    if (el) {
      el.style.border = "3px solid #ff4d4d";
      el.style.backgroundColor = "#fff0f0";
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // âœ… 2. íŠ¹ì • run ì¹´ë“œ ìƒíƒœ ê°±ì‹ 
  function updateRunCard(runId) {
    fetch(`/run_status/${runId}`)
      .then(res => res.json())
      .then(data => {
        const card = document.getElementById(runId);
        if (!card) return;

        const statusElem = card.querySelector("h3");
        const progressElem = card.querySelector(".progress");

        // ìƒíƒœ í‘œì‹œ ê°±ì‹ 
        if (data.status === "DONE") {
          statusElem.textContent = "ğŸŸ¢ ì™„ë£Œ";
        } else if (data.status === "FAILED") {
          statusElem.textContent = "ğŸ”´ ì‹¤íŒ¨";
        } else {
          statusElem.textContent = "ğŸŸ¡ ì‹¤í–‰ ì¤‘";
        }

        // ì§„í–‰ë¥  ê°±ì‹ 
        if (progressElem) {
          progressElem.textContent = `ì§„í–‰: ${data.succeeded}/${data.total}`;
        }
      });
  }

  // âœ… 3. ëª¨ë“  ì¹´ë“œ ë°˜ë³µí•´ì„œ ìƒíƒœ polling
  function pollAllRuns() {
    document.querySelectorAll(".run-card").forEach(card => {
      updateRunCard(card.id);
    });
  }

  // âœ… 4. 3ì´ˆë§ˆë‹¤ ë°˜ë³µ ì‹¤í–‰
  setInterval(pollAllRuns, 3000);

    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
        const runId = btn.dataset.run;
        if (!confirm(`ì •ë§ë¡œ ${runId} ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        fetch(`/delete/${runId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
            if (data.success) {
                document.getElementById(runId).remove();
                alert(`âœ… ${runId} ì‚­ì œ ì™„ë£Œ`);
            } else {
                alert(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${data.message}`);
            }
            });
        });
    });
</script>

{% endblock %}
